<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Coach Dashboard</title>
  <link rel="stylesheet" href="style.css">
  <link rel="icon" href="ehcb-icon.png" type="image/png" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    .lang-switch {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 16px;
      margin: 16px 0 10px 0;
      z-index: 10;
      position: static;
    }
    .lang-switch button {
      background: #eee;
      color: #002b5c;
      border: none;
      font-weight: 700;
      border-radius: 7px;
      cursor: pointer;
      padding: 6px 30px 4px 30px;
      font-size: 1.1rem;
      transition: background 0.1s, color 0.1s;
    }
    .lang-switch .active {
      background: #002b5c;
      color: #fff;
      box-shadow: 0 2px 8px #0001;
    }
    @media (max-width: 600px) {
      .lang-switch { gap: 8px; margin: 10px 0 8px 0;}
      .lang-switch button { padding: 5px 12px 3px 12px; font-size: 1rem;}
    }
    #performanceChart { 
      background: #fff; 
      border-radius: 16px; 
      box-shadow: 0 4px 18px #0001; 
      margin-bottom: 1.5rem;
      max-width: 320px;
      height: auto !important;
      width: 98vw;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }
    .delete-btn { background: #d0021b; color: #fff; border:none; border-radius:8px; font-size: 1.2rem; padding:4px 16px; cursor:pointer; }
    .delete-btn:hover { background: #a0021b; }
    .table-scroll { overflow-x: auto; }
    #dashboard-section { margin-top:2rem; }
    #deleteErrorMsg {
      color: #b20000;
      font-size: 1rem;
      text-align: right;
      margin-bottom: 1rem;
      display: none;
    }
  </style>
</head>
<body>
  <header style="min-height: 60px;">
    <div class="header-flex" style="justify-content:space-between;align-items:center;">
      <img src="wikinger.png" alt="Wikinger-Logo" class="logo desktop-logo" />
      <h1>EHC BIEL-BIENNE U18-ELIT</h1>
      <img src="wikinger.png" alt="Wikinger-Logo" class="logo mobile-logo" />
    </div>
    <div class="lang-switch" id="lang-switch">
      <button class="active">DE</button>
      <button>FR</button>
      <button>EN</button>
    </div>
  </header>
  <nav>
    <div class="nav-cards">
      <a href="index.html" class="nav-card">Startseite</a>
      <a href="kalender.html" class="nav-card">MIH Kalender U18</a>
      <a href="https://noudi72.github.io/Cardio-App-EHCB-U18/" class="nav-card" target="_blank">Cardio-Programme</a>
      <a href="https://script.google.com/macros/s/AKfycbzkS395JUZ8Su4uxit44p8dZCKRbGDNs12fjZTdlkx_zKyTNY-9yrvymGuSedxe_pcinw/exec" class="nav-card" target="_blank">Sponser Sport Food</a>
      <a href="https://www.ehcb.ch/de/teams/u18-elit" class="nav-card" target="_blank">Spirit Homepage</a>
      <a href="feedback.html" class="nav-card">Player Feedback</a>
      <a href="dashboard.html" class="nav-card">Coach Dashboard</a>
    </div>
  </nav>
  <main id="dashboard-section">
    <div style="display:flex;align-items:center;gap:18px;">
      <img src="wikinger.png" alt="Logo" style="height:40px;"/>
      <h2 id="dashboardTitle">üìä Coach Dashboard</h2>
    </div>
    <form id="filterForm" style="margin:18px 0 28px 0;display:flex;gap:22px;align-items:center;flex-wrap:wrap;">
      <label for="date" style="font-weight:600;">Date:</label>
      <input type="date" id="date" name="date" style="padding:3px 10px;border-radius:7px;border:1.5px solid #ccc; font-size:1.08rem;">
      <label for="player" style="font-weight:600;">Player:</label>
      <input type="text" id="player" name="player" placeholder="Name" style="padding:3px 10px;border-radius:7px;border:1.5px solid #ccc; font-size:1.08rem;">
      <button type="submit" style="background:#d0021b;color:#fff;padding:10px 70px;border-radius:10px;font-size:1.3rem;font-weight:700; border:none;cursor:pointer;">Filter</button>
    </form>
    <div id="deleteErrorMsg"></div>
    <canvas id="performanceChart"></canvas>
    <div class="table-scroll">
      <table style="border-spacing:0;width:100%;max-width:100%;margin:auto;text-align:left;">
        <thead>
          <tr>
            <th>Date</th><th>Name</th><th>Feeling</th><th>Performance</th><th>Intensity</th><th>Comment</th><th>Delete</th>
          </tr>
        </thead>
        <tbody id="feedbackTableBody"></tbody>
      </table>
    </div>
  </main>
  <footer>
    ¬© 2025 EHC Biel-Bienne U18-Elit
  </footer>
  <script>
    // Sprachumschalter-Logik
    const langs = ['de','fr','en'];
    const navs = {
      de: ["Startseite","MIH Kalender U18","Cardio-Programme","Sponser Sport Food","Spirit Homepage","Player Feedback","Coach Dashboard"],
      fr: ["Accueil","Calendrier √©quipe","Programme Cardio","Sponser Sport Food","Spirit Homepage","Feedback Joueur","Coach Dashboard"],
      en: ["Home","Team Calendar","Cardio Program","Sponser Sport Food","Spirit Homepage","Player Feedback","Coach Dashboard"]
    };
    let dashboardLang = localStorage.getItem('dashboard_lang') || 'de';

    function setLang(l) {
      dashboardLang = l;
      localStorage.setItem('dashboard_lang', l);
      // Aktiver Button
      document.querySelectorAll('.lang-switch button').forEach((b, idx) => {
        b.classList.toggle('active', langs[idx] === l);
      });
      // Titel
      document.getElementById('dashboardTitle').textContent =
        l === 'fr' ? 'üìä Coach Dashboard'
        : l === 'en' ? 'üìä Coach Dashboard'
        : 'üìä Coach Dashboard';
      // Navigation
      document.querySelectorAll('.nav-card').forEach((el, idx) => {
        el.textContent = navs[l][idx];
      });
      // Filter-Labels (nur wenn gew√ºnscht)
      document.querySelector("label[for=date]").textContent =
        l==='fr'?'Date‚Äâ:':l==='en'?'Date:':'Date:';
      document.querySelector("label[for=player]").textContent =
        l==='fr'?'Joueur‚Äâ:':l==='en'?'Player:':'Player:';
      document.getElementById('filterForm').querySelector('button').textContent =
        l==='fr'?'Filtrer':l==='en'?'Filter':'Filter';
    }

    document.querySelectorAll('.lang-switch button').forEach((btn, idx) => {
      btn.onclick = ()=>setLang(langs[idx]);
    });
    setLang(dashboardLang);

    // Daten laden
    let feedbackData = [];
    async function loadFeedback() {
      try {
        const res = await fetch("https://opensheet.elk.sh/1AdcOsjQqNRl8kxY1NZ1kzA9XHyMlhXJB-yoNEo6ikQE/Feedback");
        feedbackData = await res.json();
        renderTable(feedbackData);
        renderChart(feedbackData);
      } catch (e) {
        document.getElementById('feedbackTableBody').innerHTML = '<tr><td colspan="7" style="color:#a00;font-size:1.1rem;">Keine Daten gefunden!</td></tr>';
      }
    }
    loadFeedback();

    // Tabelle und Filter
    function renderTable(data) {
      const tbody = document.getElementById('feedbackTableBody');
      if (!data.length) {
        tbody.innerHTML = '<tr><td colspan="7">No feedback found.</td></tr>';
        return;
      }
      tbody.innerHTML = '';
      data.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${row['Date']||''}</td>
          <td>${row['Name']||''}</td>
          <td>${row['Feeling']||''}</td>
          <td>${row['Performance']||''}</td>
          <td>${row['Intensity']||''}</td>
          <td>${row['Comment']||''}</td>
          <td><button class="delete-btn" onclick="deleteRow('${row['Date']}')">üóëÔ∏è</button></td>
        `;
        tbody.appendChild(tr);
      });
    }

    document.getElementById('filterForm').onsubmit = function(e){
      e.preventDefault();
      const dateVal = document.getElementById('date').value;
      const playerVal = document.getElementById('player').value.trim().toLowerCase();
      let filtered = feedbackData;
      if(dateVal) filtered = filtered.filter(r=>r['Date'] && r['Date'].startsWith(dateVal.split('-').reverse().join('.')));
      if(playerVal) filtered = filtered.filter(r=>(r['Name']||'').toLowerCase().includes(playerVal));
      renderTable(filtered);
      renderChart(filtered);
    }

    // Chart
    let chart;
    function renderChart(data) {
      // Werte f√ºr Performance
      const performanceCounts = [0,0,0,0,0,0];
      data.forEach(r => {
        const val = parseInt(r['Performance']);
        if(val >=1 && val <=6) performanceCounts[val-1]++;
      });
      const ctx = document.getElementById('performanceChart').getContext('2d');
      if(chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['1','2','3','4','5','6'],
          datasets: [{
            data: performanceCounts,
            backgroundColor: ['#ff4d4d','#ffa940','#ffe066','#5cb85c','#249045','#3580db'],
            borderWidth: 2,
          }]
        },
        options: {
          cutout: '65%',
          responsive: true,
          plugins: {
            legend: { display: false }
          }
        }
      });
    }

    // L√∂schen
    async function deleteRow(timestamp) {
      if(!confirm('Wirklich l√∂schen?')) return;
      try {
        document.getElementById('deleteErrorMsg').style.display = 'none';
        await fetch('https://script.google.com/macros/s/AKfycbyiIid-_2rgFMNPLjEdCESNArd4uvsG_s_n2k-C9p58HCBBGgJFFBNxzlVuRnefCaeeBQ/exec', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: "delete", timestamp })
        });
        await loadFeedback();
      } catch (e) {
        document.getElementById('deleteErrorMsg').textContent = 'Fehler beim L√∂schen!';
        document.getElementById('deleteErrorMsg').style.display = 'block';
      }
    }
    window.deleteRow = deleteRow;
  </script>
</body>
</html>